<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ููุตุฉ ูุบุชู - ุงูุฅุตุฏุงุฑ ุงูุฃูู</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- ======= ุงูุดุฑูุท ุงูุนููู ======= -->
  <header class="topbar">
    <nav class="nav">
      <div class="nav-left">
        <img class="brand-logo" src="https://home.moe.gov.om/templates/moe/assets/images/sliders/others/MOE.png" alt="logo">
        <span class="brand-title">ููุตุฉ ูุบุชู - ุงูุฅุตุฏุงุฑ ุงูุฃูู</span>
      </div>
      <div class="nav-center" id="navLinks"></div>

      <div class="nav-right">
        <button id="logoutBtn" class="chip ghost">ุฎุฑูุฌ</button>
      </div>
    </nav>
  </header>

  <!-- ======= ุดุงุดุฉ ุงูุฏุฎูู / ุงูุชุณุฌูู ======= -->
  <section id="authView" class="center-stage">
    <div class="auth-card glass">

      <div class="hero">
        <h1>ุฃูููุง ุจู ๐</h1>
        <p class="muted">ุณุฌูู ุฏุฎููู ุฃู ุฃูุดุฆ ุญุณุงุจูุง ุฌุฏูุฏูุง</p>
      </div>

      <div class="tabs-inline center">
        <button class="pill active" data-auth="login">ุชุณุฌูู ุงูุฏุฎูู</button>
        <button class="pill" data-auth="register">ุฅูุดุงุก ุญุณุงุจ</button>
      </div>

      <!-- ๐น ุชุณุฌูู ุงูุฏุฎูู -->
      <form id="loginForm" class="form">
        <div class="form-row">
          <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <input type="email" id="loginEmail" required placeholder="name@example.com">
        </div>
        <div class="form-row">
          <label>ูููุฉ ุงููุฑูุฑ</label>
          <input type="password" id="loginPass" required placeholder="โขโขโขโขโขโขโขโข">
        </div>

        <button id="loginBtn" class="btn primary full" type="submit">ุฏุฎูู</button>
        <p id="loginMsg" class="msg"></p>
      </form>

      <!-- ๐น ุฅูุดุงุก ุญุณุงุจ -->
      <form id="regForm" class="form hidden">
        <div class="row2">
          <div class="form-row">
            <label>ุงูุงุณู ุงููุงูู</label>
            <input type="text" id="regName" required>
          </div>
          <div class="form-row">
            <label>ุงูุฏูุฑ</label>
            <select id="regRole" required>
              <option value="student">ุทุงูุจ</option>
              <option value="teacher">ูุนูู</option>
            </select>
          </div>
        </div>

        <div class="row2">
          <div class="form-row">
            <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
            <input type="email" id="regEmail" required>
          </div>
          <div class="form-row">
            <label>ูููุฉ ุงููุฑูุฑ</label>
            <input type="password" id="regPass" minlength="6" required>
          </div>
        </div>

        <button id="registerBtn" class="btn full" type="submit">ุฅูุดุงุก ุงูุญุณุงุจ</button>
        <p id="regMsg" class="msg"></p>
      </form>

      <!-- ุฒุฑ Google ุฏุงุฎู ุจุทุงูุฉ ุงูุฏุฎูู -->
      <div style="margin-top:1rem;text-align:center">
        <button id="googleLogin" class="google-btn">
          <img src="https://developers.google.com/identity/images/g-logo.png" width="20" alt="">
          ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู Google
        </button>
      </div>
    </div>
  </section>

  <!-- ======= ูููู ุงูุชุทุจูู ======= -->
  <div id="appShell" class="app hidden">

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู ูุณุงุฑูุง -->
    <main class="stage">
      <!-- ุชุจููุจ ุงูุฑุฆูุณูุฉ -->
      <section class="view tab hidden" id="tab-home">
        <div class="welcome">
          <h2><span id="helloName">ูุฑุญุจูุง!</span></h2>
          <p class="muted">ุงุจุฏุฃ ูู ููุง: ุชุนููู โ ุงูุฑุฃ โ ุฃูุฌุฒ.</p>
          <div class="cards-4">
            <div class="card action">
              <div class="icon">๐</div>
              <h4>ุงูุฏุฑูุณ</h4>
              <button class="btn sky small go" data-go="#tab-levels">ูุชุญ</button>
            </div>
            <div class="card action">
              <div class="icon">๐</div>
              <h4>ูุงุฌุจุงุชู</h4>
              <button class="btn vio small go" data-go="#tab-assign">ูุชุญ</button>
            </div>
            <div class="card action">
              <div class="icon">๐ง</div>
              <h4>ุชุณุฌูู ุงููุฑุงุกุฉ</h4>
              <button class="btn em small go" data-go="#tab-library">ูุชุญ</button>
            </div>
            <div class="card action">
              <div class="icon">๐</div>
              <h4>ุชูุงุฑูุฑู</h4>
              <button class="btn primary small go" data-go="#tab-reports">ูุชุญ</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ุชุจููุจ ุงููุณุชููุงุช -->
      <section class="view tab hidden" id="tab-levels">
        <div class="section-header">
          <h3>ุงููุณุชููุงุช</h3>
        </div>
        <div id="levelsGrid" class="grid levels"></div>
      </section>

      <!-- ุชุจููุจ ูุงุฌุจุงุช ุงูุทุงูุจ -->
      <section class="view tab hidden" id="tab-assign">
        <div class="section-header">
          <h3>ูุงุฌุจุงุชู</h3>
          <div class="tabs-inline">
            <button class="pill active" data-filter="required">ุงููุทููุจุฉ</button>
            <button class="pill" data-filter="overdue">ูุชุฃุฎุฑุฉ</button>
            <button class="pill" data-filter="done">ุงูููุฌุฒุฉ</button>
          </div>
        </div>
        <div id="assignList" class="assign-list"></div>
      </section>

      <!-- ุชูุงุฑูุฑ ุงูุทุงูุจ -->
      <section class="view tab hidden" id="tab-reports">
        <div class="section-header"><h3>ุชูุงุฑูุฑู</h3></div>
        <div class="cards-3">
          <div class="card stat"><h4>ูุณุจุฉ ุงูุฅูุฌุงุฒ</h4><div class="big" id="repPercent">0%</div></div>
          <div class="card stat"><h4>ุนุฏุฏ ุงููุฑุงุกุงุช</h4><div class="big" id="repReads">0</div></div>
          <div class="card stat"><h4>ููุช ุงููุฑุงุกุฉ</h4><div class="big" id="repTime">0 ุฏูููุฉ</div></div>
        </div>
        <div class="card"><canvas id="chartReads" height="140"></canvas></div>
      </section>

      <!-- ููุญุฉ ุงููุนูู -->
      <section class="view tab hidden" id="tab-teacher">
        <div class="section-header">
          <h3>ููุญุฉ ุงููุนูู</h3>
        </div>

        <div class="cards-3">
          <div class="card stat"><h4>ุงูุทูุงุจ</h4><div class="big" id="tc-stu">0</div></div>
          <div class="card stat"><h4>ุงููุงุฌุจุงุช</h4><div class="big" id="tc-asg">0</div></div>
          <div class="card stat"><h4>ุงูููุฌุฒุฉ</h4><div class="big" id="tc-done">0</div></div>
        </div>

        <div class="card donut-card">
          <h4 style="text-align:center;margin-bottom:10px">ูุชูุณุท ุฅูุฌุงุฒ ุงูุทูุจุฉ</h4>
          <canvas id="chartAvgProgress" height="180"></canvas>
        </div>
      </section>

      <!-- ุฅุฏุงุฑุฉ ุงูุทูุงุจ -->
      <section class="view tab hidden" id="tab-teacher-students">
        <div class="section-header">
          <h3>ุฅุฏุงุฑุฉ ุงูุทูุงุจ</h3>
          <button class="btn sky small" id="addStudentBtn">ุฅุถุงูุฉ ุทุงูุจ</button>
        </div>
        <div class="table">
          <div class="thead">
            <div>ุงูุงุณู</div>
            <div>ุงูุจุฑูุฏ</div>
            <div>ุงููุตู</div>
            <div>ุฅุฌุฑุงุกุงุช</div>
          </div>
          <div id="studentsRows" class="tbody"></div>
        </div>
      </section>

      <!-- ุฅุฏุงุฑุฉ ุงููุงุฌุจุงุช -->
      <section class="view tab hidden" id="tab-teacher-assignments">
        <div class="section-header">
          <h3>ุฅุฏุงุฑุฉ ุงููุงุฌุจุงุช</h3>
          <button class="btn primary small" id="newAssignBtn">ุฅุถุงูุฉ ูุงุฌุจ</button>
        </div>

        <div id="teacherAssignList" class="assign-list"></div>

        <div class="card">
          <canvas id="chartTeacher" height="120"></canvas>
        </div>

        <div class="table">
          <div class="thead">
            <div>ุงูุทุงูุจ</div>
            <div>ุนููุงู ุงููุงุฌุจ</div>
            <div>ุงูุญุงูุฉ</div>
            <div>ุงูุชูุฏูู</div>
            <div>ููุงุญุธุงุช</div>
            <div>ุฅุฌุฑุงุกุงุช</div>
          </div>
          <div id="teacherRows" class="tbody"></div>
        </div>
      </section>

      <!-- ุงูููุชุจุฉ -->
      <section class="view tab hidden" id="tab-library">
        <div class="section-header">
          <h3>ุงูููุชุจุฉ</h3>
          <input type="search" id="searchBooks" class="search" placeholder="ุงุจุญุซ ุนู ูุตุฉโฆ">
          <button class="btn vio small only-teacher" id="addBookBtn">ุฅุถุงูุฉ ูุตุฉ</button>
          <button class="btn em small only-teacher" id="addQuizBtn">ุฅุถุงูุฉ ุฃูุดุทุฉ</button>
        </div>
        <div id="booksGrid" class="grid books"></div>
      </section>
    </main>

    <!-- ุงูุณูุฉ ุงููููู ุงูุซุงุจุชุฉ -->
    <aside class="rail">
      <div class="profile-card glass">
        <div class="avatar">๐</div>
        <div class="pname">
          <strong id="userName">โ</strong>
          <small id="userRoleLabel">โ</small>
        </div>
      </div>
      <div class="score-card glass">
        <div class="score-row"><span>ุงููุชุจ</span><b id="railBooks">0</b></div>
        <div class="score-row"><span>ุงูููุช</span><b id="railTime">0ุฏ</b></div>
        <div class="score-row"><span>ุงูุฃูุณูุฉ</span><b id="railBadges">0</b></div>
      </div>
      <div class="score-card glass">
        <div class="score-row"><span>ูุชูุณุท ุงููุฑุงุกุฉ</span><b id="railAvg">0 ุฏ</b></div>
        <div class="score-row"><span>ุขุฎุฑ ูุตุฉ</span><b id="railLastBook">โ</b></div>
        <div class="score-row"><span>ุงูุฃูุดุทุฉ</span><b id="railActs">0</b></div>
      </div>
    </aside>
  </div>

  <!-- ูุงุฑุฆ ุงููุต -->
  <section id="readerView" class="reader hidden">
    <header class="reader-top">
      <button id="backToApp" class="btn ghost small">๐ ุงูุนูุฏุฉ</button>
      <h2 id="storyTitle">ุนููุงู ุงููุตุฉ</h2>
      <span class="level-chip" id="storyLevel">ุงููุณุชูู 1</span>
    </header>
    <div class="story-meta">
      <img id="storyCover" src="https://picsum.photos/160/210" alt="ุบูุงู" class="story-cover">
      <div class="hints">
        <div>๐ ุงุถุบุท ุงููููุงุช ูุชุธููููุง</div>
        <div>๐ค ุณุฌูู ูุฑุงุกุชู ุซู ุงุณุชูุน</div>
      </div>
    </div>
    <article id="storyContent" class="story-content"></article>
    <div class="story-actions">
      <button id="startRec" class="btn small">๐ค ุงุจุฏุฃ ุงูุชุณุฌูู</button>
      <button id="stopRec" class="btn small hidden">โน๏ธ ุฅููุงู</button>
      <button id="playRec" class="btn small hidden">โถ๏ธ ุชุดุบูู</button>
      <span id="recordTime">โฑ๏ธ 00:00</span>
      <button id="openActivitiesBtn" class="btn sky" style="margin:20px 0">ุงูุฃูุดุทุฉ ๐</button>
    </div>
  </section>

  <!-- ููุฏุงู: ุฅูุดุงุก ูุงุฌุจ -->
  <div class="modal hidden" id="modalAssign">
    <div class="modal-card">
      <button class="modal-close" data-close="modalAssign">โ</button>
      <h3>ุฅูุดุงุก ูุงุฌุจ ูุฑุงุกุฉ</h3>
      <div class="form-row"><label>ุงูุนููุงู</label><input type="text" id="aTitle" placeholder="ุงูุฑุฃ ูุตุฉ ูู ุงููุณุชูู 2 ูุงุณุชุฎุฑุฌ ุงูููุฑุฉ"></div>
      <div class="form-row"><label>ุงููุณุชูู</label><select id="aLevel"></select></div>
      <div class="form-row"><label>ุชุงุฑูุฎ ุงูุชุณููู</label><input type="date" id="aDue"></div>
      <div class="form-row"><label>ุงูุชุนูููุงุช</label><textarea id="aDesc" placeholder="ุณุฌูู ุตูุชู ูุฃุฌุจ ุนู ุงูุฃุณุฆูุฉ"></textarea></div>
      <div class="form-row"><label>ุฅุฑุณุงู ุฅูู ุงูุทูุงุจ</label><div id="studentsChecklist" class="checklist"></div></div>
      <div class="row"><button class="btn primary small" id="saveAssign">ุญูุธ</button></div>
    </div>
  </div>

  <!-- ููุฏุงู: ุฅุถุงูุฉ ุทุงูุจ -->
  <div class="modal hidden" id="modalStudent">
    <div class="modal-card">
      <button class="modal-close" data-close="modalStudent">โ</button>
      <h3>ุฅุถุงูุฉ ุทุงูุจ</h3>
      <div class="form-row"><label>ุงูุงุณู ุงููุงูู</label><input type="text" id="sName" placeholder="ุงูุงุณู"></div>
      <div class="form-row"><label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label><input type="email" id="sEmail" placeholder="student@example.com"></div>
      <div class="form-row">
        <label>ุงูุตู</label>
        <input id="sClass" type="text" placeholder="ูุซูุงู: ุงูุตู ุงูุณุงุฏุณ">
      </div>
      <div class="form-row"><label>ูููุฉ ุงููุฑูุฑ</label><input type="password" id="sPass" placeholder="ูกูขูฃูคูฅูฆ"></div>
      <div class="row"><button class="btn small" id="saveStudent">ุฅุถุงูุฉ</button></div>
      <p class="muted" style="margin-top:.4rem">* ุฅุถุงูุฉ ูุญููุฉ ููุชุฌุฑุจุฉ โ ููุชู ุญูุธูุง ูู Firestore ูููุตู ุงูุญุงูู.</p>
    </div>
  </div>

  <!-- ููุฏุงู ุงุฎุชุจุงุฑ ุงููุตุฉ -->
  <div id="modalQuiz" class="modal hidden">
    <div class="modal-card" style="max-width:600px">
      <button class="modal-close" id="closeQuiz">โ</button>
      <h3>ุงุฎุชุจุงุฑ ุงููุตุฉ</h3>
      <div id="quizContent"></div>
      <button class="btn primary full" id="submitQuiz">ุฅููุงุก ุงูุงุฎุชุจุงุฑ</button>
    </div>
  </div>

  <!-- ููุฏุงู ุฅุถุงูุฉ ูุตุฉ -->
  <div class="modal hidden" id="modalBook">
    <div class="modal-card" style="max-width:600px">
      <button class="modal-close" data-close="modalBook">โ</button>
      <h3>ุฅุถุงูุฉ ูุตุฉ ุฌุฏูุฏุฉ</h3>
      <div class="form-row"><label>ุงูุนููุงู</label><input type="text" id="bTitle" placeholder="ุนููุงู ุงููุตุฉ"></div>
      <div class="form-row">
        <label>ุงููุณุชูู</label>
        <select id="bLevel">
          <option value="L1">ุงููุณุชูู 1</option>
          <option value="L2">ุงููุณุชูู 2</option>
          <option value="L3">ุงููุณุชูู 3</option>
          <option value="L4">ุงููุณุชูู 4</option>
        </select>
      </div>
      <div class="form-row"><label>ุฑุงุจุท ุงูุตูุฑุฉ</label><input type="text" id="bCover" placeholder="https://โฆ"></div>
      <div class="form-row"><label>ุงููุต (ุณุทุฑ ููู ููุฑุฉ)</label><textarea id="bText" rows="5" placeholder="ุงูููุฑุฉ ุงูุฃูููโฆ"></textarea></div>
      <button id="saveBook" class="btn primary full">ุญูุธ ุงููุตุฉ</button>
    </div>
  </div>

  <!-- ููุฏุงู ุฅุถุงูุฉ ุฃุณุฆูุฉ ูููุตุฉ -->
  <div class="modal hidden" id="modalQuizEditor">
    <div class="modal-card" style="max-width:600px">
      <button class="modal-close" data-close="modalQuizEditor">โ</button>
      <h3>ุฅุถุงูุฉ ุฃุณุฆูุฉ ูููุตุฉ</h3>
      <div class="form-row"><label>ุงุฎุชุฑ ุงููุตุฉ</label><select id="qBookSelect"></select></div>
      <div class="form-row"><label>ุงูุณุคุงู</label><input type="text" id="qText" placeholder="ูุต ุงูุณุคุงู"></div>
      <div class="form-row"><label>ุงูุฎูุงุฑุงุช (ุณุทุฑ ููู ุฎูุงุฑ)</label><textarea id="qOptions" rows="4" placeholder="ุงูุฎูุงุฑ 1โฆ"></textarea></div>
      <div class="form-row"><label>ุฑูู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (0โ3)</label><input type="number" id="qCorrect" min="0" max="3"></div>
      <button id="saveQuiz" class="btn primary full">ุฅุถุงูุฉ ุงูุณุคุงู</button>
    </div>
  </div>

  <!-- ุณูุฑุจุช Firebase + ุชุณุฌูู ุฏุฎูู Google -->
<script type="module">
  // ๐น ุชุนุฑูู ุงููุนูู ุงูุฑุฆูุณ
  const MAIN_TEACHER_UID   = "pcjID2PpIENNI36UOMfr5xbSQwE2";
  const MAIN_TEACHER_EMAIL = "sultan.1429@edu.moe.om";
  const MAIN_TEACHER_NAME  = "ุฃ.ุณูุทุงู ุจู ุนุจุฏุงููู ุงูุดูููู";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  import { loadStudentAnswersFromFirestore, syncBooks } from "./app.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCcgfkdGNTZhqPxoY765hf53jh9KqOQPxU",
    authDomain: "my-language2025.firebaseapp.com",
    projectId: "my-language2025",
    storageBucket: "my-language2025.firebasestorage.app",
    messagingSenderId: "531458626572",
    appId: "1:531458626572:web:711af89cd9019f0ee64a29",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);
  window.db = db;

  // ๐ฅ ุญู ุงููุดููุฉ: ุงูุชุธุฑ ุชุญููู ุงูุตูุญุฉ ุจุงููุงูู
  window.addEventListener("DOMContentLoaded", () => {

    const googleBtn = document.getElementById("googleLogin");
    if (!googleBtn) {
      console.error("โ ุฒุฑ Google ุบูุฑ ููุฌูุฏ");
      return;
    }

    googleBtn.addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        console.log("โ Logged in with Google:", user.email);

        const isTeacher = (user.email === MAIN_TEACHER_EMAIL);

        // ๐จโ๐ซ ุงููุนูู
        if (isTeacher) {
          let classId = null;
          const classesSnap = await getDocs(collection(db, "classes"));

          classesSnap.forEach(c => {
            const data = c.data();
            if (data.teacherId === user.uid || data.teacherId === MAIN_TEACHER_UID) {
              classId = c.id;
            }
          });

          if (!classId) {
            alert("โ ูุง ููุฌุฏ ุตู ูุฑุชุจุท ุจุงููุนูู.");
            return;
          }

          localStorage.setItem("arp.current", JSON.stringify({
            id: user.uid,
            name: user.displayName || MAIN_TEACHER_NAME,
            email: user.email,
            role: "teacher",
            classId
          }));

          window.startApp?.();
          return;
        }

        // ๐จโ๐ ุงูุทุงูุจ
        const studentId = user.email;
        let classId = null;

        const classesSnap2 = await getDocs(collection(db, "classes"));

        for (const c of classesSnap2.docs) {
          const stuRef = doc(db, "classes", c.id, "students", studentId);
          const stuSnap = await getDoc(stuRef);
          if (stuSnap.exists()) {
            classId = c.id;
            break;
          }
        }

        if (!classId) {
          alert("โ ูุณุช ูุณุฌููุง ูู ุฃู ุตู.");
          return;
        }

        localStorage.setItem("arp.current", JSON.stringify({
          id: studentId,
          name: user.displayName || "ุทุงูุจ",
          email: studentId,
          role: "student",
          classId
        }));

        window.startApp?.();

      } catch (e) {
        console.error("Google login error:", e);
        alert("ูุดู ุชุณุฌูู ุงูุฏุฎูู: " + e.message);
      }
    });
  });
</script>



<script>
// ุชุจุฏูู ุจูู ุชุณุฌูู ุงูุฏุฎูู ูุงูุชุณุฌูู ุงูุฌุฏูุฏ
document.querySelectorAll(".pill[data-auth]").forEach(btn => {
  btn.addEventListener("click", () => {

    // ุฅุฒุงูุฉ active ูู ุงููู
    document.querySelectorAll(".pill[data-auth]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.getAttribute("data-auth");

    if (target === "login") {
      document.getElementById("loginForm").classList.remove("hidden");
      document.getElementById("regForm").classList.add("hidden");
    } else {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("regForm").classList.remove("hidden");
    }

  });
});
</script>

  
  <!-- ุชุทุจูู ุงูููุตุฉ -->
  <script type="module" src="app.js"></script>
</body>
</html>
